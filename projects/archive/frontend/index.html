<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet type=text/css href=/css/style.css><link rel=icon type=image/x-icon href=/images/favicon.ico><title>Yi Chen |</title></head><body><div id=content><header><nav><a href=/>[Home]</a>
<a href=/notes/>[Notes]</a>
<a href=/publications/>[Publications]</a>
<a href=/projects/>[Projects]</a><br><a href=https://github.com/kitkatdafu>[GitHub]</a>
<a href=https://archive.casouri.cc>[BHL0388]</a></nav></header><h1></h1><i></i>
<time datetime=0001-01-01>Jan 1, 0001</time><br><br><!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>TTS WebSocket Test Client</title><style>body{font-family:segoe ui,Tahoma,Geneva,Verdana,sans-serif;max-width:800px;margin:0 auto;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;color:#fff}.container{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border-radius:20px;padding:30px;box-shadow:0 8px 32px rgba(31,38,135,.37);border:1px solid rgba(255,255,255,.18)}h1{text-align:center;margin-bottom:30px;background:linear-gradient(45deg,#fff,#f0f0f0);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:2.5em}.input-group{margin:20px 0}label{display:block;margin-bottom:8px;font-weight:600}input,textarea,select{width:100%;padding:12px;border:none;border-radius:10px;background:rgba(255,255,255,.2);color:#fff;font-size:16px}input::placeholder,textarea::placeholder{color:rgba(255,255,255,.7)}textarea{height:120px;resize:vertical}.button-group{display:flex;gap:15px;margin:20px 0}button{flex:1;padding:12px 24px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s ease}button:hover{transform:translateY(-2px)}.connect-btn{background:linear-gradient(45deg,#4CAF50,#45a049);color:#fff}.disconnect-btn{background:linear-gradient(45deg,#f44336,#da190b);color:#fff}.speak-btn{background:linear-gradient(45deg,#2196F3,#0b7dda);color:#fff}.stop-btn{background:linear-gradient(45deg,#FF9800,#e68900);color:#fff}.status{padding:15px;margin:20px 0;border-radius:10px;text-align:center;font-weight:600}.status.connected{background:rgba(76,175,80,.3);border:2px solid #4caf50}.status.disconnected{background:rgba(244,67,54,.3);border:2px solid #f44336}.status.speaking{background:rgba(33,150,243,.3);border:2px solid #2196f3;animation:pulse 2s infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}.captions{background:rgba(0,0,0,.5);padding:20px;border-radius:10px;min-height:100px;max-height:200px;margin:20px 0;font-family:courier new,monospace;font-size:18px;line-height:1.5;overflow-y:auto;overflow-x:hidden;word-wrap:break-word;word-break:break-word;white-space:pre-wrap;position:relative}.current-char{background:gold;color:#000;padding:2px 4px;border-radius:3px;animation:highlight .5s ease;display:inline}@keyframes highlight{from{background:#ff6b6b}to{background:gold}}.caption-char{display:inline}.log{background:rgba(0,0,0,.3);padding:15px;border-radius:10px;max-height:200px;overflow-y:auto;font-family:courier new,monospace;font-size:14px}.log-entry{margin:5px 0;padding:5px;border-left:3px solid #2196f3;padding-left:10px}.log-entry.timing{border-left-color:#ff9800;color:gold}.log-entry.performance{border-left-color:#4caf50;color:#90ee90}</style></head><body><div class=container><h1>ðŸŽ¤ TTS WebSocket Test Client</h1><div class=input-group><label for=serverUrl>WebSocket Server URL:</label>
<input type=text id=serverUrl value=ws://localhost:8765 placeholder=ws://localhost:8765></div><div class=button-group><button id=connectBtn class=connect-btn>Connect</button>
<button id=disconnectBtn class=disconnect-btn disabled>Disconnect</button></div><div id=status class="status disconnected">Disconnected</div><div class=input-group><label for=textInput>Text to Speak:</label>
<textarea id=textInput placeholder="Enter text here... Try: 'Hello, this is a test of the text-to-speech system!'"></textarea></div><div class=button-group><button id=speakBtn class=speak-btn disabled>Speak Text</button>
<button id=stopBtn class=stop-btn disabled>Stop</button></div><div class=input-group><label>Real-time Captions:</label><div id=captions class=captions>Captions will appear here...</div></div><div class=input-group><label>Debug Log:</label><div id=log class=log></div></div></div><script>class TTSWebSocketClient{constructor(){this.socket=null,this.audioContext=null,this.isConnected=!1,this.isSpeaking=!1,this.currentAudio=null,this.audioQueue=[],this.isPlayingQueue=!1,this.currentCharIndex=0,this.currentText="",this.totalCaptionText="",this.captionOffset=0,this.firstChunkReceived=!1,this.chunkTimings=[],this.totalChunks=0,this.chunksReceived=0,this.initUI(),this.initAudioContext()}initUI(){this.connectBtn=document.getElementById("connectBtn"),this.disconnectBtn=document.getElementById("disconnectBtn"),this.speakBtn=document.getElementById("speakBtn"),this.stopBtn=document.getElementById("stopBtn"),this.status=document.getElementById("status"),this.captions=document.getElementById("captions"),this.log=document.getElementById("log"),this.textInput=document.getElementById("textInput"),this.serverUrl=document.getElementById("serverUrl"),this.connectBtn.addEventListener("click",()=>this.connect()),this.disconnectBtn.addEventListener("click",()=>this.disconnect()),this.speakBtn.addEventListener("click",()=>this.speakText()),this.stopBtn.addEventListener("click",()=>this.stopSpeaking())}async initAudioContext(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.logMessage("Audio context initialized")}catch(e){this.logMessage("Error initializing audio context: "+e.message)}}connect(){const e=this.serverUrl.value;this.logMessage("Connecting to: "+e);try{this.socket=new WebSocket(e),this.socket.onopen=()=>{this.isConnected=!0,this.updateStatus("connected","Connected"),this.logMessage("Connected to WebSocket server"),this.socket.send(JSON.stringify({text:" ",flush:!1}))},this.socket.onmessage=e=>{this.handleMessage(e.data)},this.socket.onclose=()=>{this.isConnected=!1,this.updateStatus("disconnected","Disconnected"),this.logMessage("Disconnected from server")},this.socket.onerror=e=>{this.logMessage("WebSocket error: "+e)}}catch(e){this.logMessage("Connection error: "+e.message)}}disconnect(){this.socket&&(this.socket.send(JSON.stringify({text:"",flush:!1})),this.socket.close()),this.stopSpeaking()}async handleMessage(e){try{const n=performance.now(),t=JSON.parse(e);if(t.audio&&t.alignment){this.firstChunkReceived||(this.logTimingMessage(`First audio chunk received`,"timing"),this.firstChunkReceived=!0),this.chunksReceived++;const e={chunkNumber:this.chunksReceived,receivedAt:n,audioLength:t.audio.length,charCount:t.alignment.chars?t.alignment.chars.length:0,serverLatency:t.latency||null};this.chunkTimings.push(e);let s=`Chunk ${this.chunksReceived}: ${e.charCount} chars, ${(e.audioLength/1024).toFixed(1)}KB audio`;t.latency!==0[0]&&(s+=`, ${t.latency.toFixed(1)}ms server latency`),this.logTimingMessage(s,"timing"),this.audioQueue.push({audio:t.audio,alignment:t.alignment,receivedAt:n}),this.isPlayingQueue||this.playNextInQueue()}}catch(e){this.logMessage("Error handling message: "+e.message)}}async playNextInQueue(){if(this.audioQueue.length===0){this.isPlayingQueue=!1,this.updateStatus("connected","Connected"),this.isSpeaking=!1,this.logPerformanceStats();return}this.isPlayingQueue=!0;const e=this.audioQueue.shift();await this.playAudio(e.audio,e.alignment)}async playAudio(e,t){try{const r=performance.now();this.currentAudio&&(this.currentAudio.stop(),this.currentAudio=null);const o=atob(e),i=new Uint8Array(o.length);for(let e=0;e<o.length;e++)i[e]=o.charCodeAt(e);const n=new Float32Array(i.length/2),c=new DataView(i.buffer);for(let e=0;e<n.length;e++){const t=c.getInt16(e*2,!0);n[e]=t/32768}const a=this.audioContext.createBuffer(1,n.length,44100);a.copyToChannel(n,0);const s=this.audioContext.createBufferSource();s.buffer=a,s.connect(this.audioContext.destination),t.chars&&t.char_start_times_ms&&(this.showCaptions(t,this.captionOffset),this.captionOffset+=t.chars.length);const l=performance.now()-r,d=n.length/44100*1e3;s.onended=()=>{this.currentAudio=null,setTimeout(()=>{this.playNextInQueue()},50)},s.start(),this.currentAudio=s,this.logTimingMessage(`Audio decoded and started (${l.toFixed(1)}ms processing, ${d.toFixed(0)}ms duration)`,"performance")}catch(e){this.logMessage("Error playing audio: "+e.message),setTimeout(()=>{this.playNextInQueue()},100)}}logPerformanceStats(){if(this.chunkTimings.length===0)return;const n=this.chunkTimings.reduce((e,t)=>e+t.charCount,0),s=this.chunkTimings.reduce((e,t)=>e+t.audioLength,0)/this.chunkTimings.length,e=this.chunkTimings.filter(e=>e.serverLatency!==null),t=e.length>0?e.reduce((e,t)=>e+t.serverLatency,0)/e.length:null;this.logTimingMessage(`ðŸŽ¯ PERFORMANCE SUMMARY:`,"performance"),this.logTimingMessage(`   Chunks received: ${this.chunkTimings.length}`,"performance"),this.logTimingMessage(`   Total characters: ${n}`,"performance"),this.logTimingMessage(`   Avg chunk size: ${(s/1024).toFixed(1)}KB`,"performance"),t!==null&&(this.logTimingMessage(`   Avg server latency: ${t.toFixed(1)}ms`,"performance"),this.logTimingMessage(`   Server generation rate: ${(n/(t*this.chunkTimings.length/1e3)).toFixed(1)} chars/sec`,"performance")),this.chunkTimings=[],this.chunksReceived=0,this.firstChunkReceived=!1,this.requestStartTime=null}showCaptions(e,t=0){const s=e.chars,o=e.char_start_times_ms;if(!s||!o)return;this.totalCaptionText+=s.join("");let n="";for(let e=0;e<this.totalCaptionText.length;e++){const t=this.totalCaptionText[e];if(t===" ")n+=`<span id="char-${e}" class="caption-char">&nbsp;</span>`;else if(t===`
`)n+=`<span id="char-${e}" class="caption-char"><br></span>`;else{const s=t.replace(/[<>&"]/g,function(e){switch(e){case"<":return"&lt;";case">":return"&gt;";case"&":return"&amp;";case'"':return"&quot;";default:return e}});n+=`<span id="char-${e}" class="caption-char">${s}</span>`}}this.captions.innerHTML=n,o.forEach((e,n)=>{setTimeout(()=>{const s=t+n,e=document.getElementById(`char-${s}`);if(e){document.querySelectorAll(".current-char").forEach(e=>{e.classList.remove("current-char")}),e.classList.add("current-char");const s=this.captions,t=e.getBoundingClientRect(),n=s.getBoundingClientRect();(t.bottom>n.bottom||t.top<n.top)&&e.scrollIntoView({behavior:"smooth",block:"center"})}},e)})}speakText(){const e=this.textInput.value.trim();if(!e||!this.isConnected)return;this.stopSpeaking(),this.totalCaptionText="",this.captionOffset=0,this.audioQueue=[],this.firstChunkReceived=!1,this.chunkTimings=[],this.chunksReceived=0,this.currentText=e,this.isSpeaking=!0,this.updateStatus("speaking","Speaking..."),this.logMessage(`ðŸ“¤ Starting TTS request: "${e.substring(0,50)}${e.length>50?"...":""}" (${e.length} chars)`),this.audioContext.state==="suspended"&&this.audioContext.resume();const t=50,n=Math.ceil(e.length/t);this.totalChunks=n,this.logTimingMessage(`Sending ${n} text chunks to server...`,"timing");for(let n=0;n<e.length;n+=t){const s=e.substring(n,n+t),o=n+t>=e.length;setTimeout(()=>{this.socket&&this.isConnected&&this.socket.send(JSON.stringify({text:s,flush:o}))},n/t*100)}}stopSpeaking(){this.currentAudio&&(this.currentAudio.stop(),this.currentAudio=null),this.audioQueue=[],this.isPlayingQueue=!1,this.isSpeaking=!1,this.totalCaptionText="",this.captionOffset=0,this.chunkTimings=[],this.chunksReceived=0,this.firstChunkReceived=!1,this.isConnected?this.updateStatus("connected","Connected"):this.updateStatus("disconnected","Disconnected"),this.captions.innerHTML="Captions will appear here...",this.logMessage("ðŸ›‘ Speech stopped")}updateStatus(e,t){this.status.className=`status ${e}`,this.status.textContent=t,this.connectBtn.disabled=this.isConnected,this.disconnectBtn.disabled=!this.isConnected,this.speakBtn.disabled=!this.isConnected||this.isSpeaking,this.stopBtn.disabled=!this.isSpeaking}logMessage(e,t="normal"){const s=(new Date).toLocaleTimeString(),n=document.createElement("div");for(n.className=`log-entry ${t}`,n.textContent=`[${s}] ${e}`,this.log.appendChild(n),this.log.scrollTop=this.log.scrollHeight;this.log.children.length>100;)this.log.removeChild(this.log.firstChild)}logTimingMessage(e,t="timing"){this.logMessage(`â±ï¸ ${e}`,t)}}window.addEventListener("load",()=>{const e=new TTSWebSocketClient})</script></body></html></div><footer><p>Copyleft (â†„) 2025 Yi Chen</p><p><a href="mailto: yi.chen@wisc.edu">yi.chen@wisc.edu</a></p></footer><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],macros:{vec:["\\mathbf{#1}",1],vx:"\\vec{x}",vw:"\\vec{w}",sign:"\\textrm{sign}",norm:["\\left\\lVert#1\\right\\rVert",1],st:"\\textrm{subject to:}"}},svg:{fontCache:"global"}}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></body></html>